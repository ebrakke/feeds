{{define "watch"}}
{{template "header" .}}

<div class="max-w-4xl mx-auto">
    <div class="aspect-video bg-black rounded-lg overflow-hidden mb-4">
        <video id="player" class="w-full h-full" controls autoplay playsinline>
            <source src="{{.StreamURL}}" type="video/mp4">
            Your browser does not support the video tag.
        </video>
    </div>

    <h1 class="text-lg font-bold mb-2">{{.Video.Title}}</h1>

    <div class="flex items-center justify-between mb-4">
        <p class="text-gray-400">{{.Video.Channel}}</p>

        <div id="subscribe-container">
        {{if .Subscribed}}
            {{if eq .Subscribed "true"}}
            <span class="text-green-400 text-sm">Subscribed!</span>
            {{else if eq .Subscribed "already"}}
            <span class="text-gray-400 text-sm">Already subscribed</span>
            {{end}}
        {{else if .ExistingChannel}}
            <span class="text-gray-500 text-sm">Subscribed</span>
        {{else if and .ChannelURL .Feeds}}
            <form id="subscribe-form" class="flex items-center gap-2">
                <input type="hidden" name="channel_url" value="{{.ChannelURL}}">
                <input type="hidden" name="channel_name" value="{{.Video.Channel}}">
                <select name="feed_id" class="bg-gray-800 border border-gray-700 rounded px-2 py-1 text-sm">
                    <option value="" disabled selected>Add to...</option>
                    {{range .Feeds}}
                    <option value="{{.ID}}">{{.Name}}</option>
                    {{end}}
                    <option value="0">+ Uncategorized</option>
                </select>
                <button type="submit" id="subscribe-btn" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm inline-flex items-center gap-1">
                    <svg id="subscribe-spinner" class="hidden animate-spin h-3 w-3" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span id="subscribe-text">Subscribe</span>
                </button>
            </form>
            <script>
            document.getElementById('subscribe-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const form = this;
                const btn = document.getElementById('subscribe-btn');
                const spinner = document.getElementById('subscribe-spinner');
                const text = document.getElementById('subscribe-text');
                const container = document.getElementById('subscribe-container');

                const feedId = form.feed_id.value;
                if (!feedId) return;

                spinner.classList.remove('hidden');
                text.textContent = 'Subscribing...';
                btn.disabled = true;

                const formData = new FormData(form);
                fetch('/watch/{{.Video.ID}}/subscribe', {
                    method: 'POST',
                    body: formData
                }).then(function(response) {
                    if (response.ok || response.redirected) {
                        container.innerHTML = '<span class="text-green-400 text-sm">Subscribed!</span>';
                    } else {
                        spinner.classList.add('hidden');
                        text.textContent = 'Subscribe';
                        btn.disabled = false;
                    }
                }).catch(function() {
                    spinner.classList.add('hidden');
                    text.textContent = 'Subscribe';
                    btn.disabled = false;
                });
            });
            </script>
        {{else if not .Feeds}}
            <a href="/import" class="text-sm text-blue-400 hover:text-blue-300">Create a feed to subscribe</a>
        {{end}}
        </div>
    </div>

    <a href="https://www.youtube.com/watch?v={{.Video.ID}}" target="_blank" rel="noopener"
       class="text-sm text-gray-500 hover:text-blue-400">
        Watch on YouTube
    </a>
</div>

<script>
(function() {
    const player = document.getElementById('player');
    const videoId = '{{.Video.ID}}';
    const startTime = {{.StartTime}};
    let lastSavedTime = 0;

    // Resume from saved position
    if (startTime > 0) {
        player.currentTime = startTime;
    }

    // Save progress periodically (every 5 seconds of playback change)
    function saveProgress() {
        const currentTime = Math.floor(player.currentTime);
        const duration = Math.floor(player.duration) || 0;

        // Only save if we've moved at least 5 seconds
        if (Math.abs(currentTime - lastSavedTime) >= 5 && duration > 0) {
            lastSavedTime = currentTime;
            fetch('/watch/' + videoId + '/progress', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({progress: currentTime, duration: duration})
            }).catch(function() {}); // Ignore errors silently
        }
    }

    // Save on timeupdate (fires frequently during playback)
    player.addEventListener('timeupdate', saveProgress);

    // Save when pausing
    player.addEventListener('pause', function() {
        const currentTime = Math.floor(player.currentTime);
        const duration = Math.floor(player.duration) || 0;
        if (duration > 0) {
            fetch('/watch/' + videoId + '/progress', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({progress: currentTime, duration: duration})
            }).catch(function() {});
        }
    });

    // Save when leaving page
    window.addEventListener('beforeunload', function() {
        const currentTime = Math.floor(player.currentTime);
        const duration = Math.floor(player.duration) || 0;
        if (duration > 0) {
            navigator.sendBeacon('/watch/' + videoId + '/progress',
                JSON.stringify({progress: currentTime, duration: duration}));
        }
    });
})();
</script>

{{template "footer" .}}
{{end}}
