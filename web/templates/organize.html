{{define "organize"}}
{{template "header" .}}

<div class="max-w-2xl mx-auto">
    <h2 class="text-xl font-bold mb-2">Review Suggested Groups</h2>
    <p class="text-gray-400 mb-6">Rename groups as needed, then confirm to create feeds.</p>

    <form method="POST" action="/import/confirm" id="organize-form">
        <input type="hidden" name="groups" id="groups-json">

        <div class="space-y-4 mb-6">
            {{range $i, $group := .Suggestions}}
            <div class="bg-gray-800 rounded-lg p-4" data-group-index="{{$i}}">
                <div class="flex items-center gap-3 mb-3">
                    <input type="text"
                           class="group-name flex-1 bg-gray-700 border border-gray-600 rounded px-3 py-2 focus:outline-none focus:border-blue-500 font-medium"
                           value="{{.Name}}">
                    <span class="text-gray-400 text-sm">{{len .Channels}} channels</span>
                </div>
                <div class="text-sm text-gray-400 max-h-32 overflow-y-auto">
                    {{range .Channels}}
                    <div class="py-1">{{.Name}}</div>
                    {{end}}
                </div>
                <div class="hidden group-channels">{{range .Channels}}{{.URL}}|{{.Name}},{{end}}</div>
            </div>
            {{end}}
        </div>

        <div class="flex gap-3">
            <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded font-medium">
                Create Feeds
            </button>
            <a href="/import" class="bg-gray-700 hover:bg-gray-600 text-white py-3 px-4 rounded font-medium text-center">
                Cancel
            </a>
        </div>
    </form>
</div>

<script>
document.getElementById('organize-form').addEventListener('submit', function(e) {
    // Build groups JSON from form state
    const groups = [];
    document.querySelectorAll('[data-group-index]').forEach(div => {
        const name = div.querySelector('.group-name').value;
        const channelsStr = div.querySelector('.group-channels').textContent;
        const channels = [];

        channelsStr.split(',').forEach(ch => {
            if (ch.trim()) {
                const [url, chName] = ch.split('|');
                if (url && chName) {
                    channels.push({url: url, name: chName});
                }
            }
        });

        if (channels.length > 0) {
            groups.push({name: name, channels: channels});
        }
    });

    document.getElementById('groups-json').value = JSON.stringify(groups);
});
</script>

{{template "footer" .}}
{{end}}
